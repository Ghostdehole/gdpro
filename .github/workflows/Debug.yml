name: Test Upload-Only Workflow
run-name: Test Upload - ${{ inputs.appname }}

on:
  workflow_dispatch:
    inputs:
      server:
        description: 'Rendezvous Server'
        required: true
        default: 'test.example.com'
        type: string
      key:
        description: 'Public Key'
        required: true
        default: 'dummykey1234567890='
        type: string
      apiServer:
        description: 'API Server'
        required: true
        default: 'https://api.test.example.com'
        type: string
      custom:
        description: "Custom JSON (base64)"
        required: true
        default: 'eyJjb25uLXR5cGUiOiAidGVzdC10eXBlIn0=' # {"conn-type": "test-type"}
        type: string
      uuid:
        description: "uuid of request"
        required: true
        default: '12345678-1234-5678-1234-567812345678'
        type: string
      iconlink:
        description: "icon link (JSON string or 'false')"
        required: false
        default: 'false'
        type: string
      logolink:
        description: "logo link (JSON string or 'false')"
        required: false
        default: 'false'
        type: string
      appname:
        description: "app name"
        required: true
        default: 'TestDesk'
        type: string
      filename:
        description: "Filename"
        required: true
        default: 'testdesk'
        type: string
      extras:
        description: "extra inputs in json"
        required: true
        default: '{"version":"master","gdpro":"true","compname":"TestOrg","urlLink":"https://test.example.com","downloadLink":"https://test.example.com/download","delayFix":"false","cycleMonitor":"false","xOffline":"false","removeNewVersionNotif":"true","token":"dummy-token"}'
        type: string

env:
  # --- ä» generator-windows.txt å¤ç”¨çš„å…³é”® env ---
  SCITER_RUST_VERSION: "1.75"
  RUST_VERSION: "1.75"
  FLUTTER_VERSION: "3.24.5"
  VERSION: "${{ fromJson(inputs.extras).version }}"
  UPLOAD_ARTIFACT: 'true'
  STATUS_URL: "${{ secrets.GENURL }}/updategh"  # é»˜è®¤å€¼ï¼Œä¸‹é¢ä¼šæ ¹æ® gdpro è¦†ç›–

jobs:
  test-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for completeness)
        uses: actions/checkout@v4

      # === Step 1: è®¾ç½® STATUS_URLï¼ˆä¸ generator-windows é€»è¾‘ä¸€è‡´ï¼‰===
      - name: Set STATUS_URL for gdpro=true
        if: ${{ fromJson(inputs.extras).gdpro == 'true' }}
        run: |
          echo "STATUS_URL=${{ secrets.GENURL }}/updategh" >> "$GITHUB_ENV"

      - name: Set STATUS_URL for gdpro=false
        if: ${{ fromJson(inputs.extras).gdpro == 'false' }}
        run: |
          echo "STATUS_URL=${{ inputs.apiServer }}/api/updategh" >> "$GITHUB_ENV"

      # === Step 2: ä¸ŠæŠ¥çŠ¶æ€ï¼ˆæ¨¡æ‹Ÿå¼€å§‹ï¼‰===
      - name: Report Status - Start
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ inputs.uuid }}", "status": "5% complete (upload test)"}'

      # === Step 3: åˆ›å»º custom.txtï¼ˆä¸ generator-windows ä¸€è‡´ï¼‰===
      - name: Create custom.txt file
        shell: bash
        run: |
          echo -n "${{ inputs.custom }}" > ./custom.txt
          echo "âœ… custom.txt created"

      # === Step 4: æå– conn-typeï¼ˆä¸ generator-windows å®Œå…¨ä¸€è‡´ï¼‰===
      - name: Extract conn-type
        id: conn
        shell: bash
        run: |
          CUSTOM_B64="${{ inputs.custom }}"
          if [[ -z "$CUSTOM_B64" ]]; then
            CONN_TYPE="default"
          else
            JSON=$(echo "$CUSTOM_B64" | base64 -d 2>/dev/null || echo '{}')
            CONN_TYPE=$(echo "$JSON" | jq -r '.["conn-type"] // "default"' 2>/dev/null || echo "default")
          fi
          SANITIZED=$(echo "$CONN_TYPE" | sed 's/[^a-zA-Z0-9_.-]/_/g')
          echo "conn=$SANITIZED" >> "$GITHUB_OUTPUT"

      # === Step 5: æå– UUID å‰4ä½ï¼ˆä¸ generator-windows å®Œå…¨ä¸€è‡´ï¼‰===
      - name: Extract first 4 chars of UUID
        id: tag
        shell: bash
        run: |
          RAW_UUID="${{ github.event.inputs.uuid }}"
          CLEAN_UUID=$(echo "$RAW_UUID" | tr -d '-')
          SHORT_UUID=${CLEAN_UUID:0:4}
          echo "tag=$SHORT_UUID" >> "$GITHUB_OUTPUT"

      # === Step 6: è®¾ç½® BUILD_FILENAMEï¼ˆä¸ generator-windows å®Œå…¨ä¸€è‡´ï¼‰===
      - name: Set build filename
        id: build_name
        shell: bash
        run: |
          NAME="${{ inputs.filename }}-${{ steps.conn.outputs.conn }}-${{ steps.tag.outputs.tag }}"
          echo "BUILD_FILENAME=$NAME" >> "$GITHUB_ENV"
          echo "value=$NAME" >> "$GITHUB_OUTPUT"
          echo "âœ… Build filename set to: $NAME"

      # === Step 7: æ¨¡æ‹Ÿç”Ÿæˆ EXE/MSI æ–‡ä»¶ï¼ˆä»£æ›¿çœŸå®æ„å»ºï¼‰===
      - name: Simulate EXE and MSI generation
        shell: bash
        run: |
          mkdir -p SignOutput
          # åˆ›å»ºå‡ EXEï¼ˆå¸¦ä¸€ç‚¹å†…å®¹é¿å…ç©ºæ–‡ä»¶ï¼‰
          echo "// Fake EXE for testing upload logic" > "SignOutput/${{ steps.build_name.outputs.value }}.exe"
          chmod +x "SignOutput/${{ steps.build_name.outputs.value }}.exe"
          # åˆ›å»ºå‡ MSI
          echo "// Fake MSI for testing upload logic" > "SignOutput/${{ steps.build_name.outputs.value }}.msi"
          ls -l SignOutput/

      # === Step 8: ã€æ ¸å¿ƒã€‘å¤ç”¨ generator-windows çš„ä¸Šä¼ é€»è¾‘ ===
      - name: Send to file server (gdpro mode)
        if: ${{ fromJson(inputs.extras).gdpro == 'true' }}
        shell: bash
        env:
          BUILD_FILENAME: ${{ steps.build_name.outputs.value }}
        run: |
          EXE="./SignOutput/${BUILD_FILENAME}.exe"
          MSI="./SignOutput/${BUILD_FILENAME}.msi"
          URL="${{ secrets.GENURL }}/save_custom_client"
          TOKEN="${{ fromJson(inputs.extras).token }}"
          UUID="${{ inputs.uuid }}"

          # ä¸Šä¼  EXE
          curl -i -X POST \
            -H "Content-Type: multipart/form-data" \
            -H "Authorization: Bearer $TOKEN" \
            -F "file=@$EXE" \
            -F "uuid=$UUID" \
            "$URL"

          # ä¸Šä¼  MSIï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "$MSI" ]; then
            curl -i -X POST \
              -H "Content-Type: multipart/form-data" \
              -H "Authorization: Bearer $TOKEN" \
              -F "file=@$MSI" \
              -F "uuid=$UUID" \
              "$URL"
            echo "âœ… MSI uploaded"
          else
            echo "âš ï¸ MSI not found, skipping upload."
          fi

      # === Step 9: å¦‚æœä¸æ˜¯ gdpro æ¨¡å¼ï¼Œä¸Šä¼ åˆ° GitHub Releaseï¼ˆå¯é€‰ï¼‰===
      - name: Create GitHub Release and Upload Assets (non-gdpro)
        if: ${{ fromJson(inputs.extras).gdpro != 'true' }}
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.build_name.outputs.value }}
          name: Test Release ${{ steps.build_name.outputs.value }}
          prerelease: true
          files: |
            ./SignOutput/${{ steps.build_name.outputs.value }}.exe
            ./SignOutput/${{ steps.build_name.outputs.value }}.msi

      # === Step 10: ä¸ŠæŠ¥æˆåŠŸçŠ¶æ€ ===
      - name: Report Success
        uses: fjogeleit/http-request-action@v1
        continue-on-error: true
        with:
          url: ${{ env.STATUS_URL }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"uuid": "${{ inputs.uuid }}", "status": "Success (upload test)"}'

      - name: Final Summary
        run: |
          echo "ğŸ‰ Upload-only test completed!"
          echo "File: ${{ steps.build_name.outputs.value }}.{exe,msi}"
