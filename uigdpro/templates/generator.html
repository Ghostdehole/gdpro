<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>客户端构建器</title>

  <!-- 外部资源 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 30px;
      padding-bottom: 30px;
    }

    .form-container {
      width: 100%;
      max-width: 960px;
      padding: 0 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 28px;
      font-size: 1.8rem;
      font-weight: 600;
    }

    .card {
      background-color: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      margin-bottom: 20px;
      /* 移除 shadow-sm，避免视觉干扰 */
    }

    .card-header {
      background-color: #2a2a2a;
      color: white;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      border-bottom: 1px solid #333;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }

    .card-body {
      padding: 16px;
    }

    .form-label,
    .form-check-label {
      color: #e0e0e0;
      font-size: 14px;
    }

    .form-text,
    .text-muted {
      color: #a0a0a0 !important;
      font-size: 13px;
    }

    .form-control,
    .form-select {
      background-color: #2a2a2a;
      border: 1px solid #444;
      color: white;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 5px;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25);
    }

    .btn {
      font-size: 14px;
      padding: 8px 16px;
    }

    .platform-icons .platform-icon {
      cursor: pointer;
      opacity: 0.6;
    }
    .platform-icons .platform-icon.active {
      opacity: 1;
      color: #0d6efd;
    }

    .text-64, .text-32 {
      color: white;
      font-weight: bold;
    }

    .submit-section {
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div class="form-container">
  <h1><i class="fas fa-cogs me-2"></i> 客户端构建器</h1>

  <form id="myForm" action="/generator" method="post" enctype="multipart/form-data">

    <!-- 保存/加载配置 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-save me-2"></i> 保存/加载配置
      </div>
      <div class="card-body text-center">
        <button type="button" onclick="saveFormData()" class="btn btn-outline-primary me-2">保存配置</button>
        <input type="file" id="fileInput" style="display:none;" accept=".json" />
        <button type="button" onclick="loadFormData()" class="btn btn-outline-success">加载配置</button>
      </div>
    </div>

    <!-- 平台选择 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-desktop me-2"></i> 选择平台
      </div>
      <div class="card-body">
        <div class="platform-icons mb-3">
          <span class="fa-stack fa-lg me-2">
            <i class="fab fa-windows fa-stack-2x platform-icon active" data-platform="windows"></i>
            <strong class="fa-stack-1x text-64">64</strong>
          </span>
          <span class="fa-stack fa-lg me-2">
            <i class="fab fa-windows fa-stack-2x platform-icon" data-platform="windows-x86"></i>
            <strong class="fa-stack-1x text-32">32</strong>
          </span>
          <i class="fab fa-linux platform-icon me-2" data-platform="linux"></i>
          <i class="fab fa-android platform-icon me-2" data-platform="android"></i>
          <i class="fab fa-apple platform-icon" data-platform="macos"></i>
        </div>
        <select name="platform" id="id_platform" class="form-select mb-3">
          <option value="windows" selected>Windows 64 位</option>
          <option value="windows-x86">Windows 32 位</option>
          <option value="linux">Linux</option>
          <option value="android">Android</option>
          <option value="macos">macOS</option>
        </select>
        <div class="mb-3">
          <label for="{{ form.version.id_for_label }}" class="form-label">版本号：</label>
          {{ form.version }}
          <div class="form-text">{{ form.version.help_text }}</div>
        </div>
        <div class="form-check">
          {{ form.delayFix }}
          <label for="{{ form.delayFix.id_for_label }}" class="form-check-label">修复使用第三方 API 时的连接延迟</label>
        </div>
      </div>
    </div>

    <!-- 通用设置 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-sliders-h me-2"></i> 通用设置
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="{{ form.exename.id_for_label }}" class="form-label">配置名称（仅限英文字符）：</label>
          {{ form.exename }}
          <div id="filenameError" class="text-danger small"></div>
        </div>
        <div class="mb-3">
          <label for="{{ form.appname.id_for_label }}" class="form-label">自定义应用程序名称：</label>
          {{ form.appname }}
        </div>
        <div class="mb-3">
          <label for="{{ form.direction.id_for_label }}" class="form-label">客户端类型：</label>
          {{ form.direction }}
        </div>
        <div class="mb-3">
          <label for="{{ form.installation.id_for_label }}" class="form-label">安装行为：</label>
          {{ form.installation }}
          <small class="form-text text-muted">* 禁止安装 = 用户无法安装</small>
        </div>
        <div class="mb-3">
          <label for="{{ form.settings.id_for_label }}" class="form-label">设置权限：</label>
          {{ form.settings }}
          <small class="form-text text-muted">* 禁用设置 = 用户无法修改设置</small>
        </div>
      </div>
    </div>

    <!-- 服务器配置 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-server me-2"></i> 服务器配置
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="{{ form.serverIP.id_for_label }}" class="form-label">服务器地址 (Host)：</label>
          {{ form.serverIP }}
        </div>
        <div class="mb-3">
          <label for="{{ form.key.id_for_label }}" class="form-label">密钥 (Key)：</label>
          {{ form.key }}
        </div>
        <div class="mb-3">
          <label for="{{ form.apiServer.id_for_label }}" class="form-label">API 地址：</label>
          {{ form.apiServer }}
        </div>
        <div class="mb-3">
          <label for="{{ form.urlLink.id_for_label }}" class="form-label">门户网站：</label>
          {{ form.urlLink }}
        </div>
        <div class="mb-3">
          <label for="{{ form.downloadLink.id_for_label }}" class="form-label">更新链接：</label>
          {{ form.downloadLink }}
        </div>
        <div class="mb-3">
          <label for="{{ form.compname.id_for_label }}" class="form-label">版权归属：</label>
          {{ form.compname }}
        </div>
      </div>
    </div>

    <!-- 安全设置 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-shield-alt me-2"></i> 安全设置
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="{{ form.passApproveMode.id_for_label }}" class="form-label">认证方式：</label>
          {{ form.passApproveMode }}
        </div>
        <div class="mb-3">
          <label for="{{ form.permanentPassword.id_for_label }}" class="form-label">永久密码：</label>
          {{ form.permanentPassword }}
          <small class="form-text text-muted">* 此密码为默认值，用户可自行修改</small>
        </div>
        <div class="form-check mb-2">
          {{ form.denyLan }}
          <label for="{{ form.denyLan.id_for_label }}" class="form-check-label">禁止局域网设备发现</label>
        </div>
        <div class="form-check mb-2">
          {{ form.enableDirectIP }}
          <label for="{{ form.enableDirectIP.id_for_label }}" class="form-check-label">启用直接 IP 访问</label>
        </div>
        <div class="form-check mb-2">
          {{ form.autoClose }}
          <label for="{{ form.autoClose.id_for_label }}" class="form-check-label">用户无操作时自动关闭传入会话</label>
        </div>
        <div class="form-check mb-2">
          {{ form.hidecm }}
          <label for="{{ form.hidecm.id_for_label }}" class="form-check-label">允许从远程屏幕隐藏连接窗口</label>
        </div>
      </div>
    </div>

    <!-- 外观设置 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-paint-brush me-2"></i> 外观设置
      </div>
      <div class="card-body">
        {{ form.iconbase64.as_hidden }}
        {{ form.logobase64.as_hidden }}

        <div class="mb-3">
          <label for="{{ form.iconfile.id_for_label }}" class="form-label">应用图标（PNG 格式）：</label>
          {{ form.iconfile }}
          <div id="icon-preview" class="mt-2"></div>
        </div>

        <div class="mb-3">
          <label for="{{ form.logofile.id_for_label }}" class="form-label">品牌标识（PNG 格式）：</label>
          {{ form.logofile }}
          <div id="logo-preview" class="mt-2"></div>
        </div>

        <div class="mb-3">
          <label for="{{ form.custom_dart_file.id_for_label }}" class="form-label">自定义模板（可选）</label>
          {{ form.custom_dart_file }}
          {% if form.custom_dart_file.errors %}
            <div class="text-danger small">{{ form.custom_dart_file.errors|join:", " }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="{{ form.custom_dart_target_path.id_for_label }}" class="form-label">目标路径</label>
          {{ form.custom_dart_target_path }}
          {% if form.custom_dart_target_path.errors %}
            <div class="text-danger small">{{ form.custom_dart_target_path.errors|join:", " }}</div>
          {% endif %}
        </div>

        <div class="mb-3">
          <label for="{{ form.theme.id_for_label }}" class="form-label">主题：</label>
          {{ form.theme }} {{ form.themeDorO }}
          <div class="form-text">
            * 默认设置：允许用户更改<br>
            * 固化设置：禁止用户更改
          </div>
        </div>
      </div>
    </div>

    <!-- 权限控制 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-lock me-2"></i> 权限控制
      </div>
      <div class="card-body">
        <p class="form-text text-muted mb-3">以下权限可设为“默认”或“固化”。</p>
        {{ form.permissionsDorO }}
        <div class="mb-3">
          <label for="{{ form.permissionsType.id_for_label }}" class="form-label">权限预设：</label>
          {{ form.permissionsType }}
        </div>
        <div class="row g-2">
          {% for field in form.visible_fields %}
            {% if field.name in 'enableKeyboard,enableClipboard,enableFileTransfer,enableAudio,enableTCP,enableRemoteRestart,enableRecording,enableBlockingInput,enableRemoteModi,enablePrinter,enableCamera,enableTerminal' %}
              <div class="col-12">
                <div class="form-check">
                  {{ field }}
                  <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 高级设置 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-cog me-2"></i> 高级设置
      </div>
      <div class="card-body">
        <div class="form-check mb-3">
          {{ form.removeWallpaper }}
          <label for="{{ form.removeWallpaper.id_for_label }}" class="form-check-label">远程会话期间移除桌面壁纸</label>
        </div>
        <p class="mb-3">
          <a href="https://rustdesk.com/docs/en/self-host/client-configuration/advanced-settings/"
             target="_blank"
             rel="noopener noreferrer"
             class="text-primary text-decoration-none small">
            点击此处查看可用的高级设置列表
          </a>
        </p>
        <div class="form-check mb-2">
          {{ form.defaultManual }}
          <label for="{{ form.defaultManual.id_for_label }}" class="form-check-label">默认设置（用户可修改）</label>
        </div>
        <div class="form-check mb-2">
          {{ form.overrideManual }}
          <label for="{{ form.overrideManual.id_for_label }}" class="form-check-label">固化设置（用户不可修改）</label>
        </div>
      </div>
    </div>

    <!-- 附加功能 -->
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <i class="fas fa-code me-2"></i> 附加功能
      </div>
      <div class="card-body">
        <div class="row g-2">
          {% for field in form.visible_fields %}
            {% if field.name in 'cycleMonitor,xOffline,removeNewVersionNotif,hidePassword,hideMenuBar,removeTopNotice,password_security_length' %}
              <div class="col-12">
                <div class="form-check">
                  {{ field }}
                  <label for="{{ field.id_for_label }}" class="form-check-label">{{ field.label }}</label>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 提交按钮 -->
    <div class="d-grid submit-section">
      <button type="submit" class="btn btn-primary btn-lg px-5 py-3">
        <i class="fas fa-rocket me-2"></i>牛马开始干活
      </button>
    </div>

  </form>
</div>


<script>
document.querySelectorAll('.platform-icon').forEach(icon => {
icon.addEventListener('click', function() {
document.querySelectorAll('.platform-icon').forEach(i => i.classList.remove('active'));
this.classList.add('active');
document.getElementById('id_platform').value = this.dataset.platform;
});
});

document.getElementById("{{ form.iconfile.id_for_label }}").addEventListener('change', function(event) {
previewImage(event.target, 'icon-preview');
});
document.getElementById("{{ form.logofile.id_for_label }}").addEventListener('change', function(event) {
previewImage(event.target, 'logo-preview');
});

document.getElementById("{{ form.hidecm.id_for_label }}").addEventListener('change', function() {
if (this.checked) {
document.getElementById("passwordRequirement").style.display = 'block';
document.getElementById("{{ form.permanentPassword.id_for_label }}").focus();
document.getElementById("{{ form.passApproveMode.id_for_label }}").value = 'password';
} else {
document.getElementById("passwordRequirement").style.display = 'none';
document.getElementById("{{ form.passApproveMode.id_for_label }}").value = 'password-click';
}
});

const enableKeyboard = document.getElementById("{{ form.enableKeyboard.id_for_label }}");
const enableClipboard = document.getElementById("{{ form.enableClipboard.id_for_label }}");
const enableFileTransfer = document.getElementById("{{ form.enableFileTransfer.id_for_label }}");
const enableAudio = document.getElementById("{{ form.enableAudio.id_for_label }}");
const enableTCP = document.getElementById("{{ form.enableTCP.id_for_label }}");
const enableRemoteRestart = document.getElementById("{{ form.enableRemoteRestart.id_for_label }}");
const enableRecording = document.getElementById("{{ form.enableRecording.id_for_label }}");
const enableBlockingInput = document.getElementById("{{ form.enableBlockingInput.id_for_label }}");
const enableRemoteModi = document.getElementById("{{ form.enableRemoteModi.id_for_label }}");
const enablePrinter = document.getElementById("{{ form.enablePrinter.id_for_label }}");
const enableCamera = document.getElementById("{{ form.enableCamera.id_for_label }}");
const enableTerminal = document.getElementById("{{ form.enableTerminal.id_for_label }}");

document.getElementById("{{ form.permissionsType.id_for_label }}").addEventListener('change', function() {
if (this.value === 'full') {
[enableKeyboard, enableClipboard, enableFileTransfer, enableAudio, enableTCP,
enableRemoteRestart, enableRecording, enableBlockingInput, enableRemoteModi,
enablePrinter, enableCamera, enableTerminal].forEach(el => {
el.checked = true;
el.disabled = true;
});
} else if (this.value === 'view') {
[enableKeyboard, enableClipboard, enableFileTransfer, enableAudio, enableTCP,
enableRemoteRestart, enableRecording, enableBlockingInput, enableRemoteModi,
enablePrinter, enableCamera, enableTerminal].forEach(el => {
el.checked = false;
el.disabled = true;
});
} else if (this.value === 'custom') {
[enableKeyboard, enableClipboard, enableFileTransfer, enableAudio, enableTCP,
enableRemoteRestart, enableRecording, enableBlockingInput, enableRemoteModi].forEach(el => {
el.disabled = false;
});
enablePrinter.checked = false;
enableCamera.checked = false;
enableTerminal.checked = false;
}
});

function previewImage(input, previewContainerId) {
if (input.files && input.files[0]) {
var reader = new FileReader();
reader.onload = function(e) {
var img = document.createElement('img');
img.src = e.target.result;
img.style.maxWidth = '300px';
img.style.maxHeight = '60px';
document.getElementById(previewContainerId).innerHTML = '';
document.getElementById(previewContainerId).appendChild(img);
};
reader.readAsDataURL(input.files[0]);
}
}

const saveLoadTitle = document.getElementById("saveLoadTitle");
const saveLoadSection = document.querySelector(".save-load-section");
saveLoadTitle.addEventListener("click", () => {
saveLoadSection.style.display = saveLoadSection.style.display === "block" ? "none" : "block";
const icon = saveLoadTitle.querySelector("i");
icon.classList.toggle("fa-chevron-down");
icon.classList.toggle("fa-chevron-up");
});

async function saveFormData() {
const filename = document.getElementById("{{ form.exename.id_for_label }}").value;
if (!filename) {
document.getElementById("filenameError").textContent = "配置名称不能为空。";
return;
} else {
document.getElementById("filenameError").textContent = "";
}
const formData = {};
const form = document.getElementById("myForm");
const formDataObj = new FormData(form);
formDataObj.forEach((value, key) => {
formData[key] = value;
});
const selectElements = form.querySelectorAll('select');
selectElements.forEach(select => {
formData[select.name] = select.value;
});
const checkboxRadioElements = form.querySelectorAll('input[type="checkbox"], input[type="radio"]');
checkboxRadioElements.forEach(input => {
if (input.name) {
if (input.type === 'radio') {
// 单选框只记录选中的值
if (input.checked) {
formData[input.name] = input.value;
}
} else if (input.type === 'checkbox') {
formData[input.name] = input.checked;
}
}
});
const iconPreview = document.getElementById('icon-preview');
if (iconPreview.firstChild && iconPreview.firstChild.src.startsWith('data:image/png;base64')) {
formData.iconfile = iconPreview.firstChild.src;
} else {
const iconFile = document.getElementById("{{ form.iconfile.id_for_label }}").files[0];
if (iconFile) {
formData.iconfile = await readFileAsBase64(iconFile);
}
}
const logoPreview = document.getElementById('logo-preview');
if (logoPreview.firstChild && logoPreview.firstChild.src.startsWith('data:image/png;base64')) {
formData.logofile = logoPreview.firstChild.src;
} else {
const logoFile = document.getElementById("{{ form.logofile.id_for_label }}").files[0];
if (logoFile) {
formData.logofile = await readFileAsBase64(logoFile);
}
}
const jsonData = JSON.stringify(formData, null, 2);
const blob = new Blob([jsonData], { type: "application/json" });
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = filename + ".json";
document.body.appendChild(a);
a.click();
document.body.removeChild(a);
URL.revokeObjectURL(url);
}

async function readFileAsBase64(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = (event) => resolve(event.target.result);
reader.onerror = (error) => reject(error);
reader.readAsDataURL(file);
});
}

function loadFormData() {
const fileInput = document.getElementById("fileInput");
fileInput.click();
fileInput.addEventListener("change", (event) => {
const file = event.target.files[0];
if (file) {
const reader = new FileReader();
reader.onload = (e) => {
try {
const formData = JSON.parse(e.target.result);
for (const key in formData) {
const elements = document.querySelectorAll(`[name="${key}"], [id="${key}"]`);
if (elements.length > 0) {
elements.forEach(element => {
if (element.type === 'radio') {
if (element.value === String(formData[key])) {
element.checked = true;
}
} else if (element.type === 'checkbox') {
element.checked = Boolean(formData[key]);
} else if (element.type !== 'file') {
element.value = formData[key];
}
if (key === 'iconfile' && formData[key]) {
document.getElementById('id_iconbase64').value = formData[key];
document.getElementById('icon-preview').innerHTML = `<img src="${formData[key]}" style="max-width: 300px; max-height: 60px;">`;
}
if (key === 'logofile' && formData[key]) {
document.getElementById('id_logobase64').value = formData[key];
document.getElementById('logo-preview').innerHTML = `<img src="${formData[key]}" style="max-width: 300px; max-height: 60px;">`;
}
});
}
}
} catch (error) {
alert("加载配置失败：无效的 JSON 文件。");
}
};
reader.readAsText(file);
}
});
}
</script>
</body>
</html>
