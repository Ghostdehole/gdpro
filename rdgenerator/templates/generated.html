<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title id="pageTitle">Loading...</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      background: #f9fafb;
      text-align: center;
      color: #333;
    }
    .lang-switcher {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 14px;
    }
    .lang-btn {
      margin-left: 8px;
      padding: 4px 10px;
      background: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .lang-btn.active {
      background: #3498db;
      color: white;
    }
    .success-text {
      font-size: 1.8em;
      margin: 20px 0;
      font-weight: 600;
    }
    .download-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 500px;
      width: 90%;
    }
    .download-link {
      display: block;
      margin: 10px 0;
      padding: 12px;
      background: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .download-link:hover {
      background: #2980b9;
    }
    .platform-note {
      margin-top: 20px;
      padding: 12px;
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      text-align: left;
      max-width: 500px;
      width: 90%;
    }
    .loading {
      color: #999;
    }
  </style>
</head>
<body>

<!-- 语言切换 -->
<div class="lang-switcher">
  <span id="langLabel" class="loading">Loading...</span>
  <button class="lang-btn" data-lang="en">English</button>
  <button class="lang-btn" data-lang="zh">中文</button>
</div>

<!-- 主内容 -->
<h2 class="success-text" id="successText" class="loading">Loading...</h2>

<div class="download-section" id="downloadSection">
  <!-- 下载链接将由 JS 动态生成或填充 -->
  <p id="errorNoFile" style="display:none;" class="loading">Loading...</p>
</div>

<div id="platformNote" class="platform-note" style="display:none;"></div>

<script>
// =============================
// 配置区（这些值通常由后端模板引擎注入）
// 如果是纯静态测试，这里会显示占位符
// =============================
const CONFIG = {
  // 平台：windows, macos, linux, android
  platform: "{{ platform }}".replace(/\{\{.*?\}\}/g, 'windows'), // 回退为 windows

  // 文件信息（用于替换 {{filename}} 等）
  filename: "{{ filename }}".replace(/\{\{.*?\}\}/g, 'myapp'),
  direction: "{{ direction }}".replace(/\{\{.*?\}\}/g, 'release'),
  short_uuid: "{{ short_uuid }}".replace(/\{\{.*?\}\}/g, 'a1b2c3'),
  uuid: "{{ uuid }}".replace(/\{\{.*?\}\}/g, 'a1b2c3d4-e5f6-7890')
};

// =============================
// 工具函数
// =============================
function replacePlaceholders(str, vars) {
  return str.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    return vars[key] !== undefined ? vars[key] : match;
  });
}

// =============================
// 语言加载
// =============================
let currentLang = 'en';
let translations = {};

async function loadLanguage(lang) {
  try {
    const res = await fetch(`/locales/${lang}.json`);
    if (!res.ok) throw new Error('Not found');
    translations = await res.json();
    currentLang = lang;
    applyTranslations();
    localStorage.setItem('selectedLang', lang);
  } catch (err) {
    console.warn(`Failed to load ${lang}, fallback to en`);
    if (lang !== 'en') loadLanguage('en');
  }
}

// =============================
// 应用翻译
// =============================
function applyTranslations() {
  const t = translations;
  document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';

  // 更新标题和主文本
  document.getElementById('pageTitle').textContent = t.success || 'Build Generated';
  document.getElementById('successText').textContent = t.success || 'Build Generated';

  // 错误信息
  const errorEl = document.getElementById('errorNoFile');
  errorEl.textContent = t.errorNoFile || 'Error: No file generated';
  errorEl.style.display = 'none'; // 默认隐藏

  // 语言标签
  document.getElementById('langLabel').textContent = t.langLabel || (currentLang === 'zh' ? '语言：' : 'Language:');

  // 清空下载区域
  const downloadSection = document.getElementById('downloadSection');
  downloadSection.innerHTML = '';

  // 根据平台生成下载链接
  const { platform, filename, direction, short_uuid, uuid } = CONFIG;
  const vars = { filename, direction, short_uuid };

  if (platform.includes('window')) {
    // Windows
    const exeLink = document.createElement('a');
    exeLink.href = `/download?filename=${filename}-${direction}-${short_uuid}.exe&uuid=${uuid}`;
    exeLink.className = 'download-link';
    exeLink.textContent = replacePlaceholders(t.downloadExe || "Download {{filename}} (.exe)", vars);
    downloadSection.appendChild(exeLink);

    const msiLink = document.createElement('a');
    msiLink.href = `/download?filename=${filename}-${direction}-${short_uuid}.msi&uuid=${uuid}`;
    msiLink.className = 'download-link';
    msiLink.textContent = replacePlaceholders(t.downloadMsi || "Download {{filename}} (.msi)", vars);
    downloadSection.appendChild(msiLink);

    showPlatformNote(t.note_windows || 'Note for Windows...');
  } else if (platform.includes('mac')) {
    // macOS
    ['x86_64', 'aarch64'].forEach(arch => {
      const link = document.createElement('a');
      link.href = `/download?filename=${filename}-${arch}.dmg&uuid=${uuid}`;
      link.className = 'download-link';
      link.textContent = `${filename}-${arch}.dmg`;
      downloadSection.appendChild(link);
    });
    showPlatformNote(t.note_macos || 'Note for macOS...');
  } else if (platform === 'linux') {
    // Linux
    const formats = [
      { arch: 'x86_64', fmt: 'deb' },
      { arch: 'x86_64', fmt: 'rpm' },
      { arch: 'x86_64', fmt: 'pkg.tar.zst' },
      { arch: 'x86_64', fmt: 'AppImage' },
      { arch: 'x86_64', fmt: 'flatpak' },
      { arch: 'aarch64', fmt: 'deb' },
      { arch: 'aarch64', fmt: 'rpm' },
      { arch: 'aarch64', fmt: 'pkg.tar.zst' },
      { arch: 'aarch64', fmt: 'AppImage' },
      { arch: 'aarch64', fmt: 'flatpak' },
    ];
    formats.forEach(f => {
      const link = document.createElement('a');
      link.href = `/download?filename=${filename}-${f.arch}.${f.fmt}&uuid=${uuid}`;
      link.className = 'download-link';
      link.textContent = `${filename}-${f.arch}.${f.fmt}`;
      downloadSection.appendChild(link);
    });
    showPlatformNote(t.note_linux || 'Note for Linux...');
  } else if (platform === 'android') {
    // Android
    ['aarch64', 'x86_64', 'armv7'].forEach(arch => {
      const link = document.createElement('a');
      link.href = `/download?filename=${filename}-${arch}.apk&uuid=${uuid}`;
      link.className = 'download-link';
      link.textContent = `${filename}-${arch}.apk`;
      downloadSection.appendChild(link);
    });
    showPlatformNote(t.note_android || 'Note for Android...');
  } else {
    // 未知平台
    errorEl.style.display = 'block';
  }

  // 更新按钮状态
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.lang === currentLang);
  });
}

function showPlatformNote(text) {
  const note = document.getElementById('platformNote');
  note.textContent = text;
  note.style.display = 'block';
}

// =============================
// 初始化
// =============================
function getInitialLang() {
  const saved = localStorage.getItem('selectedLang');
  if (saved === 'zh' || saved === 'en') return saved;
  if (navigator.language.startsWith('zh')) return 'zh';
  return 'en';
}

// 绑定语言切换
document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.addEventListener('click', () => loadLanguage(btn.dataset.lang));
});

// 启动
document.addEventListener('DOMContentLoaded', () => {
  loadLanguage(getInitialLang());
});
</script>
</body>
</html>
